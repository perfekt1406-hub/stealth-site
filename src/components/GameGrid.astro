---
import GameCard from './GameCard.astro';
import gamesData from '../data/games.json';
import { getProxiedGameUrl } from '../utils/gameProxy';

interface Game {
  id: string;
  title: string;
  category: string;
  url: string;
  thumbnail?: string;
  description: string;
}

const games = gamesData as Game[];
const proxiedGames = games.map(game => ({ ...game, url: getProxiedGameUrl(game.url) }));
const categories = ['All', 'Action', 'Puzzle', 'Retro', 'Strategy'];
---

<div class="games-library">
  <div class="category-filter">
    {categories.map((category) => (
      <button 
        class="filter-button" 
        data-category={category.toLowerCase()}
        data-active={category === 'All' ? 'true' : 'false'}
      >
        {category}
      </button>
    ))}
  </div>

  <div class="games-grid" id="games-grid">
    {proxiedGames.map((game) => (
      <GameCard
        id={game.id}
        title={game.title}
        category={game.category}
        url={game.url}
        thumbnail={game.thumbnail}
        description={game.description}
      />
    ))}
  </div>

  <div class="game-viewer" id="game-viewer" style="display: none;">
    <div class="viewer-header">
      <h2 id="viewer-title"></h2>
      <button class="close-button" id="close-viewer">Ã—</button>
    </div>
    <iframe 
      id="game-iframe" 
      src="" 
      frameborder="0" 
      allowfullscreen
      loading="lazy"
      allow="fullscreen; autoplay; microphone; camera"
    ></iframe>
  </div>
</div>

<script>
  // Category filtering
    const filterButtons = document.querySelectorAll('.filter-button');
    const gameCards = document.querySelectorAll('.game-card');

    filterButtons.forEach((button) => {
      button.addEventListener('click', () => {
      const category = button.dataset.category;
        
        // Update active state
      filterButtons.forEach((btn) => btn.dataset.active = 'false');
      button.dataset.active = 'true';

        // Filter games
        gameCards.forEach((card) => {
        const gameCategory = card.querySelector('.game-category')?.textContent?.toLowerCase() || '';
        if (category === 'all' || gameCategory === category) {
          (card as HTMLElement).style.display = '';
          } else {
          (card as HTMLElement).style.display = 'none';
          }
        });
      });
    });

  // Game viewer functionality
  const playButtons = document.querySelectorAll('.play-button');
  const gameViewer = document.getElementById('game-viewer');
  const gameIframe = document.getElementById('game-iframe') as HTMLIFrameElement;
  const viewerTitle = document.getElementById('viewer-title');
  const closeButton = document.getElementById('close-viewer');

  playButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const url = button.dataset.gameUrl;
      const title = button.dataset.gameTitle;

      if (url && gameViewer && gameIframe && viewerTitle) {
        // Clear any existing reset checkers from previous games
        if ((window as any).__currentResetChecker) {
          clearInterval((window as any).__currentResetChecker);
        }

        // Store original URL to detect and prevent resets
        const originalUrl = url;
        const preventReset = () => {
          // Only restore if this is still the current game (check if viewer is still showing this game)
          if (gameViewer.style.display !== 'none' && gameIframe.src !== originalUrl && gameIframe.src !== '' && gameIframe.src.includes('localhost')) {
            // Iframe was reset to archive page - restore the game URL
            gameIframe.src = originalUrl;
          }
        };
        const checkForReset = setInterval(preventReset, 100);
        (window as any).__currentResetChecker = checkForReset;

        gameIframe.src = url;
        viewerTitle.textContent = title || 'Game';
        gameViewer.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scrolling

        // Clear reset checker after 10 seconds (give games time to load)
        setTimeout(() => {
          if ((window as any).__currentResetChecker === checkForReset) {
            clearInterval(checkForReset);
            (window as any).__currentResetChecker = null;
          }
        }, 10000);
      }
    });
  });

  if (closeButton && gameViewer) {
    closeButton.addEventListener('click', () => {
      if (gameIframe) {
        gameIframe.src = '';
      }
      gameViewer.style.display = 'none';
      document.body.style.overflow = ''; // Restore scrolling
    });
  }

  // Close on ESC key (only if panic button doesn't handle it)
  // Note: PanicButton component handles ESC globally and redirects to home
  // This handler is kept for potential future use but panic button takes priority
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && gameViewer && gameViewer.style.display !== 'none') {
      // Let panic button handle it - it will close viewer and redirect
      // This handler is secondary
    }
  });
</script>

<style>
  .games-library {
    max-width: min(1400px, 95vw);
    margin: 0 auto;
    padding: clamp(1rem, 2vw, 1.5rem) var(--spacing-unit, clamp(0.5rem, 2vw, 1rem));
    width: 100%;
    box-sizing: border-box;
  }

  .category-filter {
    display: flex;
    gap: clamp(0.4rem, 1vw, 0.5rem);
    margin: 0 auto clamp(1rem, 2vw, 1.5rem);
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    width: 100%;
    max-width: 100%;
  }

  .filter-button {
    padding: clamp(0.6rem, 1.8vw, 0.75rem) clamp(1.5rem, 4vw, 2rem);
    background: white;
    border: clamp(1px, 0.2vw, 2px) solid #e0e0e0;
    border-radius: clamp(4px, 0.5vw, 8px);
    cursor: pointer;
    font-size: clamp(0.9rem, 2.2vw, 1.1rem);
    color: #000000;
    transition: all 0.2s;
    margin: 0;
    box-sizing: border-box;
    min-height: clamp(44px, 6vw, 48px);
    min-width: clamp(80px, 12vw, 120px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .filter-button:hover {
    border-color: var(--accent, #0066cc);
    background: #f0f7ff;
    transform: scale(1.05);
  }

  .filter-button:active {
    transform: scale(0.95);
  }

  .filter-button[data-active="true"] {
    background: var(--accent, #0066cc);
    color: white;
    border-color: var(--accent, #0066cc);
  }

  .games-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(clamp(250px, 30vw, 320px), 1fr));
    gap: clamp(1rem, 2.5vw, 1.5rem);
    margin: 0 auto clamp(1rem, 2vw, 1.5rem);
    max-width: 100%;
    width: 100%;
    padding: 0;
    box-sizing: border-box;
    justify-items: center;
  }

  @media (max-width: 768px) {
    .games-grid {
      grid-template-columns: repeat(auto-fill, minmax(clamp(220px, 40vw, 280px), 1fr));
      gap: clamp(1rem, 2.5vw, 1.5rem);
    }
  }

  @media (max-width: 480px) {
    .games-grid {
      grid-template-columns: repeat(auto-fill, minmax(clamp(180px, 45vw, 240px), 1fr));
      gap: clamp(0.75rem, 2vw, 1rem);
    }
  }

  .game-viewer {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    margin: 0;
    padding: 0;
    overflow: hidden;
    box-sizing: border-box;
  }

  .viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: clamp(0.6rem, 1.5vw, 0.75rem) clamp(1.2rem, 3vw, 1.5rem);
    background: rgba(0, 0, 0, 0.9);
    border-bottom: clamp(1px, 0.1vw, 2px) solid #333;
    flex-shrink: 0;
    min-height: clamp(45px, 6vw, 50px);
    width: 100%;
    box-sizing: border-box;
  }

  .viewer-header h2 {
    margin: 0 auto;
    color: white;
    font-size: clamp(1rem, 2.2vw, 1.25rem);
    text-align: center;
    flex: 1;
  }

  .close-button {
    background: none;
    border: none;
    color: white;
    font-size: clamp(1.5rem, 4vw, 2.5rem);
    cursor: pointer;
    padding: clamp(0.5rem, 1.5vw, 0.75rem);
    line-height: 1;
    transition: color 0.2s, transform 0.2s;
    flex-shrink: 0;
    margin: 0;
    box-sizing: border-box;
    min-height: clamp(44px, 6vw, 48px);
    min-width: clamp(44px, 6vw, 48px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-button:hover {
    color: #ff6b6b;
    transform: scale(1.1);
  }

  .close-button:active {
    transform: scale(0.9);
  }

  .game-viewer iframe {
    flex: 1;
    width: 100%;
    height: 100%;
    min-height: 0;
    border: none;
    background: #000;
    display: block;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
</style>
