---
// PanicButton component - ESC key handler
// Opens a starred topic page, or random topic if none are starred
---

<script>
  // List of all available topics
  const allTopics = [
    'algebra-basics',
    'calculus-i',
    'physics-fundamentals',
    'organic-chemistry',
    'world-war-ii',
    'ancient-rome',
    'shakespeare-studies',
    'modern-poetry',
    'data-structures',
    'web-development'
  ];

  function getStarredTopics(): string[] {
    try {
      const stored = localStorage.getItem('starredTopics');
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      return [];
    }
  }

  function getRandomTopic(): string {
    const randomIndex = Math.floor(Math.random() * allTopics.length);
    return allTopics[randomIndex];
  }

  function getTargetTopic(): string {
    const starred = getStarredTopics();
    
    // #region agent log
    fetch('http://127.0.0.1:7245/ingest/7d8b9925-f31a-4a15-803a-7f6dc755d070',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PanicButton.astro:30',message:'Getting target topic',data:{starredCount:starred.length,starredTopics:starred},timestamp:Date.now()})}).catch(()=>{});
    // #endregion

    if (starred.length > 0) {
      // Pick a random starred topic
      const randomIndex = Math.floor(Math.random() * starred.length);
      return starred[randomIndex];
    } else {
      // Pick a random topic from all available
      return getRandomTopic();
    }
  }

  function initPanicButton(): void {
    // Global ESC key listener for panic button
    document.addEventListener('keydown', (e) => {
      // Check for ESC key
      if (e.key === 'Escape' || e.keyCode === 27) {
        // Prevent default behavior
        e.preventDefault();
        e.stopPropagation();

        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/7d8b9925-f31a-4a15-803a-7f6dc755d070',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PanicButton.astro:50',message:'ESC key pressed - panic button triggered',data:{timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});
        // #endregion

        // Close any open game viewer immediately
        const gameViewer = document.getElementById('game-viewer');
        const gameIframe = document.getElementById('game-iframe') as HTMLIFrameElement;
        
        if (gameViewer && gameViewer.style.display !== 'none') {
          // #region agent log
          fetch('http://127.0.0.1:7245/ingest/7d8b9925-f31a-4a15-803a-7f6dc755d070',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PanicButton.astro:59',message:'Closing game viewer',data:{timestamp:Date.now()},timestamp:Date.now()})}).catch(()=>{});
          // #endregion
          
          if (gameIframe) {
            gameIframe.src = '';
          }
          gameViewer.style.display = 'none';
          document.body.style.overflow = '';
        }

        // Get target topic (starred or random)
        const targetTopic = getTargetTopic();
        const targetPath = `/topic/${targetTopic}`;

        // Navigate to topic page immediately (instant redirect)
        // #region agent log
        fetch('http://127.0.0.1:7245/ingest/7d8b9925-f31a-4a15-803a-7f6dc755d070',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'PanicButton.astro:74',message:'Redirecting to topic',data:{targetTopic,targetPath,currentPath:window.location.pathname},timestamp:Date.now()})}).catch(()=>{});
        // #endregion
        
        window.location.href = targetPath;
      }
    }, true); // Use capture phase to ensure this runs first
  }

  // Initialize when DOM is ready
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPanicButton);
    } else {
      initPanicButton();
    }
  }
</script>
