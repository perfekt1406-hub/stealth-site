---
// PanicButton component - ESC key handler
// Opens a starred topic page, or random topic if none are starred
---

<script>
  // List of all available topics
  const allTopics = [
    'algebra-basics',
    'calculus-i',
    'physics-fundamentals',
    'organic-chemistry',
    'world-war-ii',
    'ancient-rome',
    'shakespeare-studies',
    'modern-poetry',
    'data-structures',
    'web-development'
  ];

  function getStarredTopics(): string[] {
    try {
      const stored = localStorage.getItem('starredTopics');
      return stored ? JSON.parse(stored) : [];
    } catch (e) {
      return [];
    }
  }

  function getRandomTopic(): string {
    const randomIndex = Math.floor(Math.random() * allTopics.length);
    return allTopics[randomIndex];
  }

  function getTargetTopic(): string {
    const starred = getStarredTopics();

    if (starred.length > 0) {
      // Pick a random starred topic
      const randomIndex = Math.floor(Math.random() * starred.length);
      return starred[randomIndex];
    } else {
      // Pick a random topic from all available
      return getRandomTopic();
    }
  }

  function initPanicButton(): void {
    // Global ESC key listener for panic button
    document.addEventListener('keydown', (e) => {
      // Check for ESC key
      if (e.key === 'Escape' || e.keyCode === 27) {
        // Prevent default behavior
        e.preventDefault();
        e.stopPropagation();

        // Close any open game viewer immediately
        const gameViewer = document.getElementById('game-viewer');
        const gameIframe = document.getElementById('game-iframe') as HTMLIFrameElement;
        
        if (gameViewer && gameViewer.style.display !== 'none') {
          if (gameIframe) {
            gameIframe.src = '';
          }
          gameViewer.style.display = 'none';
          document.body.style.overflow = '';
        }

        // Get target topic (starred or random)
        const targetTopic = getTargetTopic();
        const targetPath = `/topic/${targetTopic}`;

        // Navigate to topic page immediately (instant redirect)
        window.location.href = targetPath;
      }
    }, true); // Use capture phase to ensure this runs first
  }

  // Initialize when DOM is ready
  if (typeof window !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPanicButton);
    } else {
      initPanicButton();
    }
  }
</script>
